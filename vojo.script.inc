<?php

/**
 * @file
 *     voipscripts for vojo hosted service.
 */

/**
 * VoIP Script Callback: Organic group options.
 *
 * $param['nid'] = Node ID.
 */
function _vojo_group($node) {
  $script = new VoipScript('vojo_group');

  $script->addLabel('begin');
  $script->addSay($node->title . '. ');

  $script->addLabel('intro');
  $text = t('To hear blogs press 1. To make an blog press 2. To return and select another group press the pound key.') . ' ';
  $script->addGetInput($text, 1, '', 6);
  $script->addGotoIf('play_blogs', "^%input_digits == '1'");
  $script->addGotoIf('record_blog', "^%input_digits == '2'");
  $script->addGotoIf('return', "^%input_digits == '#'");
  $script->addSay(t('Input not recognized'));

  $script->addGoto('intro');
  $script->addLabel('play_blogs');
  $params = array('view_name' => 'og_ghp_ron_voip', 'display_id' => 'voipviews_1', 'args' => json_encode(array($node->nid)));
  $script->addGosub('voipviews_read_view', $params);
  $script->addGoto('begin');

  $script->addLabel('record_blog');
  $script->addGosub('vojo_record_blog', array('nid' => $node->nid));
  $script->addGoto('begin');

  $script->addLabel('return');
  return $script;
}

/**
 * VoIP Script Callback: Record blog node in group.
 *
 * $param['nid'] = Node ID.
 */
function _vojo_record_blog($node) {
  $script = new VoipScript('vojo_record_blog');
 
  $script->addGosub('vojo_login', array('number' => '%caller_number'));
  $script->addSet('og_group', $node->title);

  $script->addLabel('start');
  $script->addRecord(
    'Start recording your message for %og_group after the tone. Press the pound key to stop recording.', 
    5, '#', 3600, 'mp3', TRUE
  );
  $script->addGotoIf('no recording detected','^%recording_duration == 0');
  $script->addSay('You said %recording_public_url');
  
  $script->addLabel('accept menu');
  $script->addGetInput(
    'To accept this recording, press 1. To record it once again, press 2. To return, press the pound key.',
    10, '', 1
  );
  $script->addGotoIf('accept recording', "^%input_digits == '1'");
  $script->addGotoIf('start', "^%input_digits == '2'");
  $script->addGotoIf('end record', "^%input_digits == '#'");
  // fall through to accept recording if no input (could be hang-up)
  $script->addLabel('accept recording');
  $script->addSay('Please wait while we save your blog post');
  $script->addGosub('vojo_save_blog', array('nid' => $node->nid, 'fid' => '%recording_fid'));

  $script->addLabel('no recording detected');
  $script->addSay("No recording detected. Please try again.");
  $script->addGoto('start');

  $script->addLabel('end record');
  return $script;
}

/**
 * VoIP Script Callback: Save announcment file to node.
 *
 * $param['nid'] = Group node ID.
 * $param['fid'] = File ID (%recording_fid).
 */
function _vojo_save_blog($nid, $fid) {
  global $user;
  $script = new VoipScript('vojo_save_blog');

  $node = new StdClass();
  $node->type = 'blog';
  $node->status = 1;
  $node->title = ''; // autogenerated
  $node->uid = $user->uid ? $user->uid : vojo_og_anon_get_user_id();
  $node->og_groups = array($nid => $nid);
  $field = content_fields('field_voipnode_adesc', 'blog');
  $target_dir = filefield_widget_file_path($field, $user);
  $file = db_fetch_object(db_query('SELECT * FROM {files} WHERE fid = %d', $fid));
  if (! file_copy($file, $target_dir,  FILE_EXISTS_RENAME)) {
    watchdog('vojo', 'Upload error. Could not move file %file to destination %destination.', array('%file' => $file->filename, '%destination' => $target_dir));
    $script->addSay('Error saving blog.');
    return $script;
  }
  $file = (array) $file;
  $file['list'] = array();
  if ($field['list_field']) {
    $file['list'] = $field['list_default'];
  }
  $node->field_voipnode_adesc[0] = $file;
  
  node_save($node);

  $script->addSay('blog saved.');
  return $script; 
}

/**
 * Log user in based on sms_user number.
 */
function _vojo_login($number) {
  global $user;
  $script = new VoipScript('vojo_login');
  $uid = sms_user_get_uid($number);
  if ($uid) {
    $user = user_load($uid);
    watchdog('vojo', 'Voip call associated with user %name.', array('%name' => $user->name));
  }
  else {
    $user = user_load(0);
  }

  $script->addSet('user_uid', $user->uid);
  $script->addSet('user_name', $user->name);

  return $script;
}
