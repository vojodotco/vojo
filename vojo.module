<?php

// Optimization: maintain a single-query-duration cache of published story counts per group
$_vojo_group_published_story_counts = array();

/**
 * Load up helpers
 */
function vojo_init(){
    // load custom blocks
    module_load_include('inc', 'vojo', 'includes/vojo.blocks');  
    // load costom voip-drupal scripts
    module_load_include('inc', 'vojo', 'includes/vojo.script');
}

/**
 * Helper function to find out how many stories are published within a group.  This is written
 * to be called by themes and custom panels/blocks if they need to embed the count somewhere.  This
 * manages a qingle-query-duration cache for you.
 */
function vojo_group_published_story_count($group_id) {
    global $_vojo_group_published_story_counts;
    $story_count = 0;
    if(array_key_exists($group_id,$_vojo_group_published_story_counts)){
        $story_count = $_vojo_group_published_story_counts[$group_id];
    } else {
        $results = db_query("SELECT count(n.nid) as story_count 
                         FROM {og_ancestry} as oga, {node} as n
                         WHERE oga.nid=n.nid AND oga.group_nid=$group_id AND n.status=1", $group_id);
        while ($object = db_fetch_object($results)) {
            $story_count = $object->story_count;
        }
        $_vojo_group_published_story_counts[$group_id] = $story_count;
    }
    return $story_count;
}

/**
 * Use this to get the path to an image inside the "img" dir of this module
 */
function _vojo_image_path($imgfile){
    return theme_image(drupal_get_path('module','vojo')."/img/".$imgfile);
}

/**
 * Implementation of hook_voipscript_load_script().
 */
function vojo_voipscript_load_script($script_name, $params = NULL) {
    if ($script_name == 'vojo_group') {
        module_load_include('inc', 'vojo', 'vojo.script');
        $node = node_load($params['nid']);
        return _vojo_group($node);
    }
    elseif ($script_name == 'vojo_record_blog') {
        module_load_include('inc', 'vojo', 'vojo.script');
        $node = node_load($params['nid']);
        return _vojo_record_blog($node);
    }
    elseif ($script_name == 'vojo_save_blog') {
        module_load_include('inc', 'vojo', 'vojo.script');
        return _vojo_save_blog($params['nid'], $params['fid']);
    }
    elseif ($script_name == 'vojo_login') {
        module_load_include('inc', 'vojo', 'vojo.script');
        return _vojo_login($params['number']);
    }
}

/**
 * Implementation of hook_voipscript_get_script_names().
 */
function vojo_voipscript_get_script_names() {
  return array(
    'vojo_group',
    'vojo_record_blog',
    'vojo_save_blog',
    'vojo_login',
  );
}

/**
 * Implementation of hook_ctools_plugin_dierctory() to let the system know
 * we implement task and task_handler plugins.
 */
function vojo_ctools_plugin_directory($module, $plugin) {
  return 'plugins/' . $plugin;
}
